# CEDC开发角度文档

**C**loud base **E**TL **D**evOps process of **C**ommunity = **CEDC**

## 一. 开发环境及工具

### 1.1注册帐号

#### （1）AWS账号注册

##### [aws官网](https://portal.aws.amazon.com/billing/signup#/start/email)

##### [aws注册教程（无信用卡版）](https://aws.tcloudpower.com/?id=12)

##### [aws注册教程（有信用卡版）](https://blog.csdn.net/jiuhebaobao/article/details/126726475?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168257490216800188555866%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168257490216800188555866&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-126726475-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=aws%E6%B3%A8%E5%86%8C&spm=1018.2226.3001.4187)

#### （2）Github账号注册

##### [GitHub官网](https://github.com/)

###### 注册完成后将Gitee帐号发送给Carrie等待加入项目群组

#### （3）Gitee账号注册

##### [Gitee官网](https://gitee.com/)



### 1.2软件下载

#### （1）python（3..以上版本）

##### [python官网](https://www.python.org/downloads/)

##### [python安装教程](https://blog.csdn.net/qq_45502336/article/details/109531599?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168254488516800192266658%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168254488516800192266658&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-2-109531599-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=python%E5%AE%89%E8%A3%85&spm=1018.2226.3001.4187)

#### （2）pycharm

##### [pycharm官网](https://www.jetbrains.com/pycharm/download/#section=windows)

##### [pycharm安装教程](https://blog.csdn.net/weixin_46211269/article/details/119934323?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168255595116800217275524%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168255595116800217275524&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-119934323-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=pycharm%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B&spm=1018.2226.3001.4187)

#### （3）notepad++

##### [notepad++官网（可能无法访问）](https://link.csdn.net/?target=https%3A%2F%2Fnotepad-plus-plus.org%2F)

##### [notepad++安装教程](https://blog.csdn.net/qq_44111805/article/details/127822507?ops_request_misc=&request_id=&biz_id=102&utm_term=notepad++%E5%AE%89%E8%A3%85&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-127822507.142^v86^insert_down1,239^v2^insert_chatgpt&spm=1018.2226.3001.4187)

#### （4）winscp

##### [winscp官网](https://winscp.net/eng/download.php)

##### [winscp安装教程](https://blog.csdn.net/qq_26383975/article/details/120220823?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168257881316800184158985%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168257881316800184158985&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-120220823-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=winscp%E4%B8%8B%E8%BD%BD&spm=1018.2226.3001.4187)

#### （5）git

##### [git官网](https://git-scm.com/)

##### [git安装教程](https://blog.csdn.net/mukes/article/details/115693833?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168264147316800211519102%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168264147316800211519102&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-115693833-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=git%E5%AE%89%E8%A3%85&spm=1018.2226.3001.4187)

#### （6）DBeaver

##### [DBeaver官网](https://dbeaver.io/)

##### [DBeaver安装教程](https://blog.csdn.net/weixin_48053866/article/details/125815498?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168264315516800215097087%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168264315516800215097087&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-125815498-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=DBeaver%E5%AE%89%E8%A3%85&spm=1018.2226.3001.4187)

#### （7）aws命令行

##### [aws命令行配置](https://kdocs.cn/l/ctN7A08Lm6QX)

#### （8）Docker Desktopi（暂时不需要安装）

##### [Docker Desktop官网](https://www.docker.com/)

##### [Docker Desktop安装教程](https://blog.csdn.net/weixin_42222436/article/details/125945225?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522168264326816800226548780%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=168264326816800226548780&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-125945225-null-null.142^v86^insert_down1,239^v2^insert_chatgpt&utm_term=docker%20desktop%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B&spm=1018.2226.3001.4187)



#### *上述提到的七个软件已上传至网盘 链接如下

百度网盘链接:[点击跳转网盘](https://pan.baidu.com/s/1CCsD2U8n2mTWwBq12uODqg)

提取码：matc 



## 二. 项目或功能（需求）描述

This project is aiming to build a whole cloud based DevOps ETL process. Include below Parts:

1. Cloud Infrastructure
   - Jenkins
   - Airflow
2. Airflow framework
3. Jenkins Devops Pipeline
4. Glue ETL Comm······················on Solution
5. Multi-account architecture



## 三、模块与关系

### basic logicflow

[![img](https://camo.githubusercontent.com/27d1d644aa96dadfe2e019b694e1626bf85acc3f40732e53ea05ef5367307240/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f62617369635f6c6f676963666c6f772e706e67)](https://camo.githubusercontent.com/27d1d644aa96dadfe2e019b694e1626bf85acc3f40732e53ea05ef5367307240/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f62617369635f6c6f676963666c6f772e706e67)

## 四、基础架构

### 4.1 Cloud Infrastructure

### Account distribution

- DevOps Account: this is a DevOps account mainly include Jenkins and Airflow
- Data Account: this is a data lake account mainly include S3
- Serverless Account: this is a ETL account mainly include Glue, Lambda etc
- IDP Account: this is a Identity account which can assume A/B/C accounts by **User role** or **Admin Role**

[![img](https://camo.githubusercontent.com/df2bd895129b4921a9ee050f93ccaba2cd379ce2b04dfed4ec946b28a21a0b64/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f2545352541342539412545382542342541362545362538382542372545342542442539332545372542332542422545372542422539332545362539452538342e64726177696f2e706e67)](https://camo.githubusercontent.com/df2bd895129b4921a9ee050f93ccaba2cd379ce2b04dfed4ec946b28a21a0b64/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f2545352541342539412545382542342541362545362538382542372545342542442539332545372542332542422545372542422539332545362539452538342e64726177696f2e706e67)

### 4.2 Jenkins Infrastructure

[![img](https://camo.githubusercontent.com/0d24540038d081578305598411826df831bee73aced430ad0cd4fc8fb875858f/68747470733a2f2f6432393038713031766f6d7162322e636c6f756466726f6e742e6e65742f373731396131633738326131626139316330333161363832613061326638363538323039616462662f323032312f30332f32342f4a656e6b696e732e6a7067)](https://camo.githubusercontent.com/0d24540038d081578305598411826df831bee73aced430ad0cd4fc8fb875858f/68747470733a2f2f6432393038713031766f6d7162322e636c6f756466726f6e742e6e65742f373731396131633738326131626139316330333161363832613061326638363538323039616462662f323032312f30332f32342f4a656e6b696e732e6a7067)

注意：在初稿中，我们可以将所有服务集中部署到一个帐户中以进行演示。

### 4.3 Airflow framework

- Parameter driven framework
- Check Dependence
- Kickoff
- Monitor
- Job Retry
- Notify
- Metadata backend

### 4.4 Jenkins DevOps Pipeline

- Deploy airflow dags and glue job in project [![img](https://camo.githubusercontent.com/464dd47f994c312f9726184e7427eb56aa72f74597c23ebbdb63684861910585/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f6a656e6b696e735f62617369635f6469616772616d2e706e67)](https://camo.githubusercontent.com/464dd47f994c312f9726184e7427eb56aa72f74597c23ebbdb63684861910585/68747470733a2f2f67697465652e636f6d2f536978476f64323031392f7368617265642d696e666f2f7261772f6d61737465722f6769746875625f696d616765732f696d616765732f6a656e6b696e735f62617369635f6469616772616d2e706e67)
- Onboarding/Off Boarding
- Data validation
- Convert SQL to Glue Pyspark

### 4.5 Glue ETL jobs

Account prerequisite

Standard aws serverless account with below items:

- Glue
- Lambda
- S3
- Cloudwatch Events
- Cloudwatch logs
- Secrets manager
- wip ...

### 4.6 IAM Roles Management

1. Serverless Account: Glue Job Execution role -> **DEVOPS_GLUE_CEDC_EXECUTION** (cross account role to ensure Airflow can trigger glue jobs on Account C)
2. DevOps Account: **DEVOPS_GLUE_CEDC_READ**/**DEVOPS_GLUE_CEDC_ADMIN** (Readonly or Admin)
3. IDP Account: CICD Role: **DEVOPS_CICD_CEDC** (which will assume admin access for all accounts for now.)
4. Data Account: **DEVOPS_S3_CEDC_READ**/**DEVOPS_S3_CEDC_ADMIN**

## 五、数据库文档

### 5.1库存放路径



### 5.2库设计习惯



### 5.3表逻辑关系

[![p9BSR7q.png](assets/p9BSR7q.png)](https://imgse.com/i/p9BSR7q)

## 六、程序源码文档

### 6.1代码编写习惯

#### 6.1.1 airflow_workspace

```python
from datetime import datetime, timedelta
from airflow.operators.bash import BashOperator
from airflow.models import Variable
from airflow import DAG

# These args will get passed on to each operator
default_args = {
    'owner': 'cedc_airflow',
    'depends_on_past': False,
    'start_date': datetime(2023, 4, 21),
    'email': ['julie.wang@cognizant.com'],
    'email_on_failure': True,
    'email_on_retry': True,
    'email_on_success': True,
    'retries': 3,
    'retry_delay': timedelta(minutes=2)
}

dag_name = 'cedc_airflow_trigger'

# parameters for each operator
job_parms = str({"datasource_name": "sample", "dag_run_id": "hgjfgkflglg", "load_type": "ALL", "run_type": "glue",
                 "glue_template_name": "devops.prelanding.s3_file_movement",
                 "dag_id": "first_dag", "execution_date": datetime(2023, 4, 23), "waiting_time": 4,
                 "max_waiting_count": 2, "base_url": "http://43.143.250.12:8080",
                 "status": "Succeed", "job_name": "cdec_airflow_daily_loading"})

# timedelta 1: dag run by days
dag = DAG(
    dag_id=dag_name,
    default_args=default_args,
    description='This DAG will run cedc_airflow_trigger, hard code parameters',
    schedule_interval=timedelta(days=1),
    catchup=False
)

start = BashOperator(
    task_id='start',
    bash_command='echo start',
    dag=dag
)

dependency_check = BashOperator(
    task_id='dependency_check',
    bash_command=Variable.get('python') + ' ' + Variable.get(
        'main') + ' --trigger=' + 'dependency_check' + ' --params=' + job_parms + '',
    dag=dag
)

kick_off = BashOperator(
    task_id=dag_name + '_job_kick_off_wrapper',
    bash_command=Variable.get('python') + ' ' + Variable.get(
        'main') + ' --trigger=' + 'start' + ' --params=' + job_parms + '',
    dag=dag
)

monitor = BashOperator(
    task_id=dag_name + '_job_monitoring_wrapper',
    bash_command=Variable.get('python') + ' ' + Variable.get(
        'main') + ' --trigger=' + 'monitor_batch' + ' --params=' + job_parms + '',
    dag=dag,
)

notify = BashOperator(
    task_id=dag_name + '_job_notify_wrapper',
    bash_command=Variable.get('python') + ' ' + Variable.get(
        'main') + ' --trigger=' + 'batch_notify' + ' --params=' + job_parms + '',
    dag=dag
)

trigger_next_dag = BashOperator(
    task_id=dag_name + '_job_trigger_next_dag_wrapper',
    bash_command=Variable.get('python') + ' ' + Variable.get(
        'main') + ' --trigger=' + 'trigger_next_dag' + ' --params=' + job_parms + '',
    dag=dag
)

stop = BashOperator(
    task_id='stop',
    bash_command='echo stop',
    dag=dag
)

start >> dependency_check >> kick_off >> monitor >> notify >> trigger_next_dag >> stop
```

#### 6.1.2 glue_workspace

```sql
select first(user_aliases.name) as name,
sum(sales_aliases.amount) as total_amount
from user_aliases
inner join sales_aliases
on user_aliases.user_id = sales_aliases.user_id
where sales_aliases.amount > 0
group by name
order by total_amount
```

```
glue命名规范
<project_name>_<table_name or process_name>_prelanding
<project_name>_<table_name or process_name>_landing
<project_name>_<table_name or process_name>_landing_merge
<project_name>_<table_name or process_name>_refinement
<project_name>_<table_name or process_name>_publish
```

### 6.2程序文件清单



### 6.3关键文档清单



### 6.4函数库



